<%= f.error_notification ticket: f.object.errors[:ticket].to_sentence %>

<div class="form-group row">
  <div class="col-sm-7">
    <div class="row">
      <% if current_user.is_admin? %>
        <div class="col-12 col-md-12">
          <% selected_value = @ticket.user_id.present? ? @ticket.user_id : nil %>
          <%= f.label "Nombre de usuario *" %><br>
          <%= f.select :user_id, options_for_select(@users.sort, selected_value), include_blank: true, multiple: false %><br/>

          <% f.object.errors.messages[:user].each do |message| %>
            <p class="text-danger mb-2"><%= message %></p>
          <% end %>
        </div>

        <div class="col-12 col-md-12">
          <%= f.input :description, as: :text, required: true %>
        </div>
      <% end %>

      <div class="col-12 col-sm-12">
        <% selected_value = @ticket.new_record? ? nil : @ticket.subcategory.category.id %>
        <%= f.label :category %><br>
        <%= select_tag "category", 
            options_from_collection_for_select(Helpcenter::Category.all, "id", lambda { |cat| "#{cat.name} (#{cat.profile.name})"}, selected_value),
            prompt: "Selecciona una categoría",
            :onchange => "update_ticket_subscategories(this.value)" 
        %>
      </div>

      <div class="col-12 col-md-12">
        <% selected_value = @ticket.new_record? ? nil : @ticket.subcategory.id %>
        <%= f.label "Subcategoría *" %><br>
        <%= f.select :subcategory_id, 
            options_from_collection_for_select(@subcategories || [], "id", "name", selected_value), 
            prompt: "Selecciona una subcategoría",
            required: true
        %>
      </div>
    </div>
  </div>

  <% if current_user.is_admin? %>
    <div class="col-5">
      <div class="col-12">
        Archivos <br>
        <%= f.file_field :files, multiple: true %>
      </div>
    </div>
  <% end %>
</div>

<%= f.submit nil, :class => 'btn btn-primary' %>

<script>
$(document).on("turbolinks:load", function() {
  $("#ticket_category_id").select2({
    tags: false,
    placeholder: "Seleccionar Categoría",
    width: "100%"
  });

  $("#ticket_subcategory_id").select2({
    tags: false,
    placeholder: "Seleccionar Subcategoría",
    width: "100%"
  });

  $("#ticket_user_id").select2({
    tags: false,
    placeholder: "Seleccionar Usuario",
    width: "100%"
  });
});

function update_ticket_subscategories(category_id) {  
  jQuery.ajax({
    url: `/admin/helpcenter_tickets/subcategories`,
    type: "GET",
    data: { "category_id": category_id },
    dataType: "script"
  });
}
</script>